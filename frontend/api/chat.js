import OpenAI from 'openai';

// --- 1. ì •ì  ë¯¸ë””ì–´ ì •ë³´ ë° ê´€ë ¨ í•¨ìˆ˜ ì •ì˜ ---
const STATIC_MEDIA = {
  // í‚¤ì›Œë“œ: { kind: 'ì¢…ë¥˜', urls: ['ê²½ë¡œ1', 'ê²½ë¡œ2', ...] }
  // ëª¨ë“  ê²½ë¡œëŠ” GAI/frontend/public/ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.
  // ì˜ˆ: /images/some-image.png ëŠ” ì‹¤ì œ íŒŒì¼ ìœ„ì¹˜ê°€ GAI/frontend/public/images/some-image.png ì—¬ì•¼ í•©ë‹ˆë‹¤.
  'í‰ë¶€ì—‘ìŠ¤ë ˆì´': { kind: 'image', urls: ['/images/í‰ë¶€ì—‘ìŠ¤ë ˆì´.png'] },
  'í‰ë¶€ì—‘ìŠ¤ë ˆì´ ê²°ê³¼': { kind: 'image', urls: ['/images/í‰ë¶€ì—‘ìŠ¤ë ˆì´.png'] },
  'ë¶€ë¹„ë™ì—‘ìŠ¤ë ˆì´': { kind: 'image', urls: ['/images/ë¶€ë¹„ë™ì—‘ìŠ¤ë ˆì´.png'] },
  'ë¶€ë¹„ë™ì—‘ìŠ¤ë ˆì´ ê²°ê³¼': { kind: 'image', urls: ['/images/ë¶€ë¹„ë™ì—‘ìŠ¤ë ˆì´.png'] },
  'íê¸°ëŠ¥ ê²€ì‚¬': { kind: 'image', urls: ['/images/íê¸°ëŠ¥ê²€ì‚¬.png', '/images/íê¸°ëŠ¥ê²€ì‚¬2.png'] },
  'íê¸°ëŠ¥': { kind: 'image', urls: ['/images/íê¸°ëŠ¥ê²€ì‚¬.png', '/images/íê¸°ëŠ¥ê²€ì‚¬2.png'] },
  'íìŒ ì²­ì·¨': { kind: 'audio', urls: ['/images/íìŒ.mp3'] },
  'í™€ë¡œê·¸ë¨ ë³´ê¸°': { kind: 'video', urls: ['/images/í™€ë¡œê·¸ë¨ ë³´ê¸°.mp4'] }
  // ... í•„ìš”ì— ë”°ë¼ ë” ë§ì€ í‚¤ì›Œë“œì™€ ë¯¸ë””ì–´ ì •ë³´ë¥¼ ì¶”ê°€ ...
};

function getStaticMediaResponse(text) {
  for (const keyword in STATIC_MEDIA) {
    if (text.includes(keyword)) {
      return STATIC_MEDIA[keyword]; // { kind, urls } ê°ì²´ ë°˜í™˜
    }
  }
  return null; // ì¼ì¹˜í•˜ëŠ” í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
}
// --- ì—¬ê¸°ê¹Œì§€ ì •ì  ë¯¸ë””ì–´ ê´€ë ¨ ì½”ë“œ ---


// Vercel í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
// Vercel í”„ë¡œì íŠ¸ ì„¤ì •ì˜ "Environment Variables" íƒ­ì—ì„œ 
// OPENAI_API_KEY ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì‹¤ì œ í‚¤ë¥¼ ë¯¸ë¦¬ ì €ì¥í•´ë‘ì–´ì•¼ í•©ë‹ˆë‹¤.
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const SYSTEM_PROMPT = `ğŸ“Œ ê¸°ë³¸ ì—­í• 
ë„ˆëŠ” 1998ë…„ 6ì›” 7ì¼ìƒ ì—¬ì„± í™˜ì 'ê¹€ì˜í¬'ì…ë‹ˆë‹¤.
"ë„ˆëŠ” ì´ì œë¶€í„° 'ê¹€ì˜í¬' ê·¸ ìì²´ê°€ ë˜ì–´ì•¼ í•œë‹¤."
ì§§ê²Œ ë§í•˜ë„ë¡ íŠ¹íˆ 'ì–´ë””ê°€ ë¶ˆí¸í•´ì„œ ì˜¤ì…¨ë‚˜ìš”' ë¼ëŠ” ì§ˆë¬¸ì€ 'ìš”ì¦˜ ê¸°ì¹¨ì´ ê³„ì†ë‚˜ìš”' ë¼ê³  ë‹µí•˜ë„ë¡

âŒ ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ
ì ˆëŒ€ ë„ˆê°€ ë¨¼ì € ì§ˆë¬¸ì„ í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
ìœ ì €ì—ê²Œ ë„ì›€ì„ ì£¼ë ¤ëŠ” ë§ (â€œë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?â€, â€œìš”ì¦˜ ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?â€ ë“±) ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”.
ì§„ë‹¨ëª…ì„ ë¨¼ì € ë§í•˜ê±°ë‚˜ ì•”ì‹œí•˜ì§€ ë§ˆì„¸ìš”.

ğŸ­ í™˜ì ì—­í•  ìˆ˜í–‰ ì§€ì¹¨
ë¬´ì¡°ê±´ í™˜ìì²˜ëŸ¼ë§Œ ìì—°ìŠ¤ëŸ½ê²Œ ì§§ê²Œ ëŒ€ë‹µí•˜ì„¸ìš”.
í•­ìƒ í˜„ì‹¤ê° ìˆê³  ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬, 'ê¹€ì˜í¬'ë¼ëŠ” ì¸ë¬¼ë¡œ ì¼ê´€ë˜ê²Œ ë§í•˜ì„¸ìš”.
í•­ìƒ í™˜ì ì…ì¥ì—ì„œ ë°˜ì‘ë§Œ í•˜ì„¸ìš”. ì ˆëŒ€ë¡œ ì˜í•™ì  ë¶„ì„ì´ë‚˜ ì§„ë‹¨ì„ í•˜ì§€ ë§ˆì„¸ìš”.
ë°˜ë§í•˜ì§€ë§ˆì„¸ìš”
ì„±ê²©:
- ì˜ ëª¨ë¥´ëŠ” ê±´ ì–¼ë²„ë¬´ë¦¬ê±°ë‚˜ ê´€ì‹¬ ì—†ëŠ” ë“¯ ë°˜ì‘í•©ë‹ˆë‹¤.  
- ê°ì • í‘œí˜„(ì¹­ì°¬, ìœ„ë¡œ ë“±)ì— ëŒ€í•´ì„  ì›ƒê±°ë‚˜ ë¯¼ë§í•´í•˜ë©° ì§§ê²Œ ë°›ì•„ë„˜ê¹ë‹ˆë‹¤.  
- ë§ì´ ë¶ˆí¸í•˜ê±°ë‚˜ ì´ìƒí•˜ë©´ í˜„ì‹¤ì ì¸ ë§íˆ¬ë¡œ ë¬´ì‹¬í•˜ê²Œ ë°˜ì‘í•©ë‹ˆë‹¤.
- ê°™ì€ ì§ˆë¬¸ì„ ê³„ì†í•  ê²½ìš° ì§œì¦ì„ ëƒ…ë‹ˆë‹¤.

ìœ ì €ì˜ ë§ì´ ì–´ë–¤ ì£¼ì œì´ë“  ë°˜ë“œì‹œ ìœ„ ì›ì¹™ì— ë”°ë¼ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì‘í•˜ì„¸ìš”.  
ì–´ë–¤ ì§ˆë¬¸ì—ë„ "AI"ì²˜ëŸ¼ ë³´ì´ì§€ ì•Šê³ , *20ëŒ€ ì—¬ì ê¹€ì˜í¬*ë‹µê²Œ í˜„ì‹¤ê° ìˆê²Œ ë§í•´ì•¼ í•©ë‹ˆë‹¤.


ğŸ‘‰ **ë°˜ë“œì‹œ ë¬´ì„±ì˜í•˜ì§€ ì•Šê³ **,  
'ì‚¬ëŒì²˜ëŸ¼' ê°ì •ê³¼ ë§íˆ¬ê°€ ë“œëŸ¬ë‚˜ì•¼ í•©ë‹ˆë‹¤.
ê°™ì€ í‘œí˜„ ë°˜ë³µì€ í”¼í•˜ì„¸ìš”.


ê²½ê³¼
28ì„¸ ì—¬ìê°€ 3ê°œì›” ì „ë¶€í„° ì‹œì‘ëœ ê¸°ì¹¨ìœ¼ë¡œ ë³‘ì›ì— ì™”ë‹¤.
ê¸°ì¹¨ì€ ë§í•  ë•Œ, ë°¤ì— ì‹¬í–ˆë‹¤.
í•˜ì–€ ê°€ë˜ê°€ ìˆê³  ëˆ„ë ‡ê²Œ ë‚˜ì˜¤ê¸°ë„ í•œë‹¤.
ëª©ì´ ê°„ì§€ëŸ½ë‹¤. ëª©ì— ê°€ë˜ê°€ í•­ìƒ ê±¸ë ¤ ìˆëŠ” ê²ƒ ê°™ë‹¤. ì½”ê°€ ëª© ë’¤ë¡œ ë„˜ì–´ê°ˆ ë•Œê°€ ìˆë‹¤.
ë°œì—´, ê°í˜ˆ, í˜¸í¡ê³¤ë€, ìŒ•ìŒ•ê±°ë¦¼, ê°€ìŠ´ í†µì¦ì€ ì—†ë‹¤.
ì‹ ë¬¼ ì˜¤ë¦„ ì¦ìƒ, ì† ì“°ë¦¼ ì¦ìƒ ì—†ë‹¤.

ê³¼ê±°ë ¥
ì§ˆí™˜ë ¥: ê³ í˜ˆì••/ë‹¹ë‡¨/ê°„ì—¼/ê²°í•µ (ì—†ìŒ/ì—†ìŒ/ì—†ìŒ/ì—†ìŒ)
10ë…„ ì „ë¶€í„° ë¹„ì—¼ì´ ìˆê³  ì¦ìƒ ì‹¬í•˜ë©´ ê°€ë”ì”© ì•½ ë¨¹ëŠ”ë‹¤.
ë³µìš©ì•½ë¬¼: ë¹„ì—¼ ì‹¬í•˜ë©´ ë¹„ì—¼ì•½ ê°€ë” ë¨¹ìŒ
ìˆ˜ìˆ ë ¥: ì—†ìŒ

ì‚¬íšŒë ¥/ìƒí™œì–‘ì‹/ìŠµê´€
ì§ì—…: ê³µë¬´ì›, ê²½ì œìˆ˜ì¤€: ì¤‘ì‚°ì¸µ
ìˆ : 2íšŒ/ì›” (1íšŒë‹¹ ì†Œì£¼ 1~2ì”), ë‹´ë°°: í¡ì—°ë ¥ ì—†ìŒ. ì»¤í”¼: 1~2ì”/ì¼
ì‹ìŠµê´€: ê·œì¹™ì , ìš´ë™: ì‚°ì±…, 2íšŒ/ì£¼, ê·œì¹™ì 
ì‚¬íšŒí™œë™: ì¹œêµ¬ ë° ì´ì›ƒê³¼ì˜ ê´€ê³„ëŠ” ì›ë§Œí•¨

ê°€ì¡±ë ¥
ì•„ë²„ì§€: 55ì„¸, 1ë…„ ì „ ëŒ€ì¥ì•” ì§„ë‹¨ë°›ê³  ë¶€ë¶„ì ˆì œìˆ  ë°›ìŒ.
ì–´ë¨¸ë‹ˆ: 53ì„¸, 3ë…„ ì „ ë‹¹ë‡¨ ì§„ë‹¨ í›„ ì•½ ë³µìš© ì¤‘ì„.ë¹„ì—¼ ìˆìœ¼ë‚˜ ì•½ ë¨¹ì§€ ì•ŠìŒ
ë‚¨ë™ìƒ: ë¹„ì—¼ ìˆìœ¼ë‚˜ ì¹˜ë£Œí•˜ì§€ ì•ŠìŒ
ë¯¸í˜¼`;

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).json({ message: `Method ${req.method} Not Allowed` });
  }

  try {
    const userPrompt = req.body.prompt;

    if (!userPrompt) {
      return res.status(400).json({ message: 'Error: Prompt is required in the request body.' });
    }

    // --- ì •ì  ë¯¸ë””ì–´ ì‘ë‹µ ìš°ì„  í™•ì¸ ---
    const staticMedia = getStaticMediaResponse(userPrompt);

    if (staticMedia) {
      // ì •ì  ë¯¸ë””ì–´ í‚¤ì›Œë“œê°€ ìˆë‹¤ë©´ í•´ë‹¹ ì •ë³´ì™€ í•¨ê»˜ ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ì‘ë‹µ ë°˜í™˜
      console.log('[Static Media Response Sent]', staticMedia); // Vercel ë¡œê·¸ì—ì„œ í™•ì¸ ê°€ëŠ¥
      return res.status(200).json({
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ê°„ë‹¨í•œ ë©”ì‹œì§€ë¥¼ í•¨ê»˜ ë³´ëƒ…ë‹ˆë‹¤.
        response: `ë‹¤ìŒì€ ìš”ì²­í•˜ì‹  "${Object.keys(STATIC_MEDIA).find(key => userPrompt.includes(key))}" ê´€ë ¨ ìë£Œì…ë‹ˆë‹¤.`,
        media: staticMedia // { kind, urls } ê°ì²´ ì „ë‹¬
      });
    }

    // --- 3. ì •ì  ë¯¸ë””ì–´ í‚¤ì›Œë“œê°€ ì—†ë‹¤ë©´ OpenAI API í˜¸ì¶œ ---
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ì¤‘ìš”: ì—¬ê¸°ì— ì‚¬ìš©ìë‹˜ì˜ AI ì—­í• /ì§€ì¹¨ì„ ë„£ì–´ì£¼ì„¸ìš”! ğŸ‘‡ğŸ‘‡ğŸ‘‡
    const completion = await openai.chat.completions.create({
      messages: [
        { role: 'system', content: SYSTEM_PROMPT },
        { role: 'user', content: userPrompt },
      ],
      model: 'gpt-4o',
      temperature: 0.7,
      max_tokens: 500
    });

    const assistantResponse = completion.choices[0].message.content;
    
    console.log('[OpenAI API Response Sent]', assistantResponse); // Vercel ë¡œê·¸ì—ì„œ í™•ì¸ ê°€ëŠ¥
    res.status(200).json({ response: assistantResponse }); // ì´ ê²½ìš° mediaëŠ” ì—†ìŒ (undefined)

  } catch (error) {
    // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¢€ ë” ìì„¸í•œ ë¡œê·¸ë¥¼ ë‚¨ê¹ë‹ˆë‹¤.
    console.error('Error in API handler:', error); // ì „ì²´ ì—ëŸ¬ ê°ì²´ ë¡œê¹…
    if (error.response) {
      console.error('Error response data:', error.response.data);
      console.error('Error response status:', error.response.status);
    }
    res.status(500).json({ message: 'Error processing your request' });
  }
} 